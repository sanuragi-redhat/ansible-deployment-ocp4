---
- name: 2. Prepare OpenShift 4.19 installation and web hosting
  hosts: service
  become: true
  vars:
    ocp_install_dir: /root/ocp4
    install_config_src: /root/ocp4/install-config.yaml
    web_dir: /var/www/html/ocp4
    install_config_file: "{{ ocp_install_dir }}/install-config.yaml"

  tasks:
    - name: 1. Ensure required packages are installed (Apache + dependencies)
      ansible.builtin.package:
        name:
          - podman 
          - buildah
          - skopeo
          - httpd
          - tar
          - gzip
        state: present

    - name: 2. Ensure Apache service is enabled and running
      ansible.builtin.service:
        name: httpd
        state: started
        enabled: true

    - name: 3. Ensure OpenShift installation directory exists
      ansible.builtin.file:
        path: "{{ ocp_install_dir }}"
        state: directory
        mode: '0755'

    - name: 4. Create install-config.yaml for OpenShift 4
      ansible.builtin.copy:
        dest: "{{ install_config_file }}"
        owner: root
        group: root
        mode: '0644'
        content: |
          apiVersion: v1
          baseDomain: blackghost.lab
          compute:
            - hyperthreading: Enabled
              name: worker
              replicas: 0
          controlPlane:
            hyperthreading: Enabled
            name: master
            replicas: 1
          metadata:
            name: prod
          networking:
            clusterNetwork:
              - cidr: 10.128.0.0/14
                hostPrefix: 22
            networkType: OVNKubernetes
            serviceNetwork:
              - 172.30.0.0/16
          platform:
            none: {}
          fips: false
          pullSecret: '{"auths":{"cloud.openshift.com":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfYmI1Y2QyODZlNzFlNDEyMTg3MjQxY2IyOTIzZjFkZmE6RFVESUdRSFNUWjVXS0FOT0ozQjNUTEZSNzE3U0tQTkhXTDQ3SjczN1ZOOTlPVjNGUlREWFhSQUVQRDFNQlFTTg==","email":"sanuragi@redhat.com"},"quay.io":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfYmI1Y2QyODZlNzFlNDEyMTg3MjQxY2IyOTIzZjFkZmE6RFVESUdRSFNUWjVXS0FOT0ozQjNUTEZSNzE3U0tQTkhXTDQ3SjczN1ZOOTlPVjNGUlREWFhSQUVQRDFNQlFTTg==","email":"sanuragi@redhat.com"},"registry.connect.redhat.com":{"auth":"fHVoYy1wb29sLTc1NDBkODYwLTM4ZTctNDVlNC05OTU4LTY1NGRiYjgxNzg5NjpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSXdPVE5rTkdNMU1UY3haVEEwWm1VellUQXlZV1ExT1RsaVlqZGhZakE1WXlKOS5lS3NCNTNfV1VRbXBLN29QYTRkaHFpODBZV3lkQlVya1RlWkc3cllkRTNqclY0TTJlc3F5MXhsdUJiTXpGQkFaNmtLMlVGVmpOSVo3eFpQVDRIYXVTSE5zYkg1ZEJJV2dTeHZWN081M1RlaUF6X0VZV1lzel9oY01vbFhva3lTMWowczJ4Y2hSeEhxRTZLbjdGR2NEbEFhQWVrWlJHYXRzUzFpWkpOekRaYzVRYUZIR3ctUC1kTGdXVktlNHVxa0ROWE1nSkNOWU4tYXJEcE1iVkV0RHJXZHhtMDBDV0JKWklqbThKbEVQTnlBN1pRaFEzY0pXNEd3bzM0SmhSRGgyX0V0U1RLMVNDN2ttYTQzWlpnVXdWaVdUZkhQNEpyajB0U3QyT3JveklldEl1MUNwSlI3WTlieHBvZy1XLVFBbVlLTkl0U0Y2Z1RXSFZ4dE85WW9DSTlhaWhrVDMtVjZMR2YtNEtHZXQzdkhWSDFqQUFzYkMzaWRoTXFlXzFZS2IyWUJscWJvTzZJYkNYd2Z1YWMxbHVkM3c3aUR1bHlwd2tpSm16V1pjdXhDM2F0LXFOZTlCTFBOSzUyR0NFRXBpcWdUUVVfRjNvOWNTN0lRdllmYlVLdUJPVGgyZXZWY1ZiOXVYZ3lHQkoxQmFSMGozTkJkbkl6OWxOX0dTZ0d5WlI1OGRUVmkxV0FmUlRlN3VRclJTZTN0OVZMLU1MR2tvY2VJR1hjbWdYZjhPbGdzck55WWh1T2FxdENOVG9yY0F6dGZrTTV4NlpmdmRWOXNDZ1ZVVDlWZGpFSkI5LThWc2FNalp0Z05wczNoby1wWm5yZXQ1cnpVYV81YjJGb0NGc1FUd0ZaT0VpYTgzVDNsd2pad3JGWkFhNktTM0RIcDlJQUN3a1VPTHVpbw==","email":"sanuragi@redhat.com"},"registry.redhat.io":{"auth":"fHVoYy1wb29sLTc1NDBkODYwLTM4ZTctNDVlNC05OTU4LTY1NGRiYjgxNzg5NjpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSXdPVE5rTkdNMU1UY3haVEEwWm1VellUQXlZV1ExT1RsaVlqZGhZakE1WXlKOS5lS3NCNTNfV1VRbXBLN29QYTRkaHFpODBZV3lkQlVya1RlWkc3cllkRTNqclY0TTJlc3F5MXhsdUJiTXpGQkFaNmtLMlVGVmpOSVo3eFpQVDRIYXVTSE5zYkg1ZEJJV2dTeHZWN081M1RlaUF6X0VZV1lzel9oY01vbFhva3lTMWowczJ4Y2hSeEhxRTZLbjdGR2NEbEFhQWVrWlJHYXRzUzFpWkpOekRaYzVRYUZIR3ctUC1kTGdXVktlNHVxa0ROWE1nSkNOWU4tYXJEcE1iVkV0RHJXZHhtMDBDV0JKWklqbThKbEVQTnlBN1pRaFEzY0pXNEd3bzM0SmhSRGgyX0V0U1RLMVNDN2ttYTQzWlpnVXdWaVdUZkhQNEpyajB0U3QyT3JveklldEl1MUNwSlI3WTlieHBvZy1XLVFBbVlLTkl0U0Y2Z1RXSFZ4dE85WW9DSTlhaWhrVDMtVjZMR2YtNEtHZXQzdkhWSDFqQUFzYkMzaWRoTXFlXzFZS2IyWUJscWJvTzZJYkNYd2Z1YWMxbHVkM3c3aUR1bHlwd2tpSm16V1pjdXhDM2F0LXFOZTlCTFBOSzUyR0NFRXBpcWdUUVVfRjNvOWNTN0lRdllmYlVLdUJPVGgyZXZWY1ZiOXVYZ3lHQkoxQmFSMGozTkJkbkl6OWxOX0dTZ0d5WlI1OGRUVmkxV0FmUlRlN3VRclJTZTN0OVZMLU1MR2tvY2VJR1hjbWdYZjhPbGdzck55WWh1T2FxdENOVG9yY0F6dGZrTTV4NlpmdmRWOXNDZ1ZVVDlWZGpFSkI5LThWc2FNalp0Z05wczNoby1wWm5yZXQ1cnpVYV81YjJGb0NGc1FUd0ZaT0VpYTgzVDNsd2pad3JGWkFhNktTM0RIcDlJQUN3a1VPTHVpbw==","email":"sanuragi@redhat.com"}}}'
          sshKey: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMR7PVTOKdgwuXSAnqTMtbLiopACChxXR4cdVoG7d0CK root@ansible-controller.blackghost.lab"

    - name: 5. Verify install-config.yaml exists
      ansible.builtin.stat:
        path: "{{ install_config_src }}"
      register: install_config_check

    - name: 6. Fail if install-config.yaml is missing
      ansible.builtin.fail:
        msg: "install-config.yaml not found in {{ install_config_src }}"
      when: not install_config_check.stat.exists

    - name: 7. Generate OpenShift manifests
      ansible.builtin.command:
        cmd: openshift-install create manifests --dir={{ ocp_install_dir }}
      args:
        chdir: "{{ ocp_install_dir }}"
      register: manifest_output
      changed_when: "'INFO' in manifest_output.stdout"

    - name: 8. Generate ignition configs
      ansible.builtin.command:
        cmd: openshift-install create ignition-configs --dir={{ ocp_install_dir }}
      args:
        chdir: "{{ ocp_install_dir }}"
      register: ignition_output
      changed_when: "'INFO' in ignition_output.stdout"

    - name: 9. Ensure web server directory exists
      ansible.builtin.file:
        path: "{{ web_dir }}"
        state: directory
        mode: '0755'
        owner: apache
        group: apache

    - name: 10. Find ignition files in OpenShift installation directory
      ansible.builtin.find:
        paths: "{{ ocp_install_dir }}"
        patterns: "*.ign"
      register: ignition_files

    - name: 11. Copy ignition files to web server directory
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ web_dir }}/{{ item.path | basename }}"
        owner: apache
        group: apache
        mode: '0644'
        remote_src: true
      loop: "{{ ignition_files.files }}"
      when: ignition_files.matched > 0

    - name: 12. Adjust permissions for ignition files
      ansible.builtin.file:
        path: "{{ web_dir }}"
        recurse: yes
        mode: '0755'

    - name: 13. Restarting Apache service 
      ansible.builtin.service: 
        name: httpd 
        state: restarted 
        enabled: true 

    - name: 14. Disable Firewalld Service 
      ansible.builtin.service: 
        name: firewalld 
        state: stopped 
        enabled: false 

    - name: 15. Display completion summary
      ansible.builtin.debug:
        msg:
          - "âœ… OpenShift ignition files generated successfully"
          - "ğŸ“ Directory: {{ web_dir }}"
          - "ğŸŒ Access URL example: http://{{ ansible_facts['default_ipv4']['address'] }}/ocp4/bootstrap.ign"
